Perfecto. Vamos con el 1:
üëâ qu√© tocar exactamente en workers/ocr_dni/processor.py, en qu√© orden, sin ambig√ºedad.

No voy a opinar ni explicar teor√≠a. Esto es instrucci√≥n directa para implementar.

‚∏ª

üéØ OBJETIVO DEL CAMBIO EN processor.py

Modificar el flujo para que ANTES de cualquier OCR pesado se ejecute:

normalize_image
‚Üí DniHeuristicAnalyzer
‚Üí selecci√≥n expl√≠cita de strategy
‚Üí OCR + parsing


‚∏ª

üìç ESTADO ACTUAL (simplificado)

Hoy processor.py hace conceptualmente algo as√≠:

image = load_image(...)
pdf417 = try_pdf417(image)
ocr_text = run_ocr(image)
parsed = parse(ocr_text, pdf417)
publish(parsed)

‚ùå Esto es lo que hay que romper.

‚∏ª

‚úÖ FLUJO FINAL OBLIGATORIO

image = load_image(...)
image = normalize_image(image)
analysis = DniHeuristicAnalyzer(image).analyze()
strategy = select_strategy(analysis.document_variant)
result = strategy.process(image)
publish(result, analysis.signals)


‚∏ª

üß© CAMBIOS CONCRETOS EN processor.py

1Ô∏è‚É£ IMPORTS (AGREGAR ARRIBA)

from preprocess.normalize import normalize_image
from heuristics.dni_heuristic_analyzer import DniHeuristicAnalyzer
from strategies.dni_new_front import DniNewFrontStrategy
from strategies.dni_new_back import DniNewBackStrategy
from strategies.dni_old import DniOldStrategy

‚ö†Ô∏è No borrar imports existentes de OCR / PDF417 / parser.

‚∏ª

2Ô∏è‚É£ FUNCI√ìN DE SELECCI√ìN DE STRATEGY (AGREGAR)

Agregar en el archivo (arriba o abajo, pero fuera del handler principal):

def select_strategy(document_variant: str):
    if document_variant == "dni_new_back":
        return DniNewBackStrategy()
    elif document_variant == "dni_new_front":
        return DniNewFrontStrategy()
    elif document_variant == "dni_old":
        return DniOldStrategy()
    else:
        raise ValueError("Unsupported or unknown DNI variant")


‚∏ª

3Ô∏è‚É£ MODIFICAR EL CORE DEL PROCESSOR

üìå DONDE hoy carg√°s la imagen (ejemplo)

Buscar algo como:

image = load_image_from_s3(...)

‚úèÔ∏è REEMPLAZAR el bloque siguiente completo por esto:

# 1. Normalizaci√≥n obligatoria
normalized_image = normalize_image(image)

# 2. Heur√≠stica DNI (ANTES del OCR)
analyzer = DniHeuristicAnalyzer(normalized_image)
analysis = analyzer.analyze()

document_variant = analysis["document_variant"]
signals = analysis["signals"]

logger.info(
    "dni_heuristic_result",
    extra={
        "document_variant": document_variant,
        "signals": signals
    }
)

# 3. Selecci√≥n expl√≠cita de strategy
strategy = select_strategy(document_variant)

# 4. OCR + parsing espec√≠fico por variante
result = strategy.process(normalized_image)

‚ùå Eliminar / no ejecutar cualquier OCR o PDF417 antes de este bloque.

‚∏ª

4Ô∏è‚É£ PUBLICACI√ìN DEL RESULTADO (AJUSTAR)

Donde hoy hac√©s publish_event(...), agregar signals y document_variant:

publish_event(
    event_type="document.extracted.v1",
    payload={
        **result,
        "document_variant": document_variant,
        "signals": signals
    }
)

‚ö†Ô∏è signals es interno: no exponer en API p√∫blica si no quer√©s, pero s√≠ en eventos/logs.

‚∏ª

5Ô∏è‚É£ MANEJO DE ERRORES (OBLIGATORIO)

Envolver el bloque principal:

try:
    ...
except ValueError as e:
    logger.error("unsupported_dni_variant", exc_info=e)
    raise

No silenciar errores.
Si document_variant == unknown ‚Üí error expl√≠cito.

‚∏ª

6Ô∏è‚É£ VALIDACIONES FINALES (CHECKLIST)

Antes de dar esto por terminado, verificar:
	‚Ä¢	‚ùå No se llama OCR antes de DniHeuristicAnalyzer
	‚Ä¢	‚ùå No se intenta PDF417 fuera de DniNewBackStrategy
	‚Ä¢	‚úîÔ∏è normalize_image() siempre se ejecuta
	‚Ä¢	‚úîÔ∏è document_variant decide la estrategia
	‚Ä¢	‚úîÔ∏è Logs NO incluyen imagen, MRZ raw ni PDF417 raw

‚∏ª

üß† RESULTADO FINAL

Despu√©s de este cambio:
	‚Ä¢	processor.py entiende qu√© est√° viendo
	‚Ä¢	El OCR se ejecuta solo cuando corresponde
	‚Ä¢	Las variantes reales que mandaste no rompen el pipeline
	‚Ä¢	El sistema es explicable y ajustable

‚∏ª

Pr√≥ximo paso (cuando quieras)

Puedo seguir con:
	‚Ä¢	exactamente qu√© poner dentro de cada Strategy.process()
	‚Ä¢	o revisi√≥n final del normalize_image()
	‚Ä¢	o tests m√≠nimos que deber√≠an pasar s√≠ o s√≠

Decime c√≥mo seguimos.