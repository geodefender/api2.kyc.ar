Perfecto. Te dejo solo el 1 y el 2, cerrados, operativos, copiables, sin tests ni teor√≠a.
Esto es implementaci√≥n literal.

‚∏ª

1Ô∏è‚É£ IMPLEMENTACI√ìN EXACTA DE CADA Strategy.process()

Regla global (no negociar):
Cada Strategy NO detecta, NO decide, NO valida.
Solo extrae usando el m√©todo que le corresponde.

‚∏ª

üü¶ DniNewBackStrategy.process(image)

Responsabilidad √∫nica: PDF417 primero, OCR solo como fallback.

class DniNewBackStrategy:
    def process(self, image):
        # PDF417 es la fuente primaria
        pdf417_raw = decode_pdf417(image)

        if pdf417_raw:
            fields = parse_pdf417(pdf417_raw)
            return {
                "source": "pdf417",
                "fields": fields,
                "confidence": 0.95
            }

        # Fallback OCR SOLO si el barcode falla
        ocr_text = run_ocr(image)
        fields = parse_dni_text(ocr_text)

        return {
            "source": "ocr_fallback",
            "fields": fields,
            "confidence": 0.60
        }

‚ùå No MRZ
‚ùå No heur√≠stica
‚ùå No logs de raw data

‚∏ª

üü¶ DniNewFrontStrategy.process(image)

Responsabilidad √∫nica: OCR estructurado del frente.

class DniNewFrontStrategy:
    def process(self, image):
        ocr_text = run_ocr(image)

        fields = {
            "apellido": extract_field(ocr_text, ["APELLIDO", "SURNAME"]),
            "nombre": extract_field(ocr_text, ["NOMBRE", "NAME"]),
            "sexo": extract_field(ocr_text, ["SEXO", "SEX"]),
            "nacionalidad": extract_field(ocr_text, ["NACIONALIDAD", "NATIONALITY"]),
            "fecha_nacimiento": extract_date(ocr_text)
        }

        return {
            "source": "ocr",
            "fields": fields,
            "confidence": 0.75
        }

‚ùå No PDF417
‚ùå No MRZ
‚ùå No parsing de dorso

‚∏ª

üü¶ DniOldStrategy.process(image)

Responsabilidad √∫nica: OCR flexible (layout no est√°ndar).

class DniOldStrategy:
    def process(self, image):
        ocr_text = run_ocr(image)

        fields = {
            "numero_documento": extract_number(ocr_text),
            "apellido": extract_field(ocr_text, ["APELLIDO"]),
            "nombre": extract_field(ocr_text, ["NOMBRE"]),
            "fecha_nacimiento": extract_date(ocr_text)
        }

        return {
            "source": "ocr",
            "fields": fields,
            "confidence": 0.65
        }

‚ùå No PDF417
‚ùå No MRZ
‚ùå No layout moderno

‚∏ª

2Ô∏è‚É£ IMPLEMENTACI√ìN FINAL DE normalize_image()

Regla global:
normalize_image() SIEMPRE se ejecuta, SIEMPRE devuelve imagen, NUNCA aborta.

‚∏ª

üìÑ preprocess/normalize.py

def normalize_image(image):
    # 1. Deskew autom√°tico (rotaci√≥n)
    try:
        image = deskew(image)
    except Exception:
        pass

    # 2. Convertir a escala de grises
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

    # 3. Recorte de fondo blanco
    try:
        gray = trim_background(gray)
    except Exception:
        pass

    # 4. Detectar documento lejano y recortar bounding box
    try:
        doc_box = find_largest_rectangular_contour(gray)
        if doc_box is not None:
            gray = crop_to_box(gray, doc_box)
    except Exception:
        pass

    # 5. Resize a ancho est√°ndar
    try:
        gray = resize_to_width(gray, 1200)
    except Exception:
        pass

    # 6. CLAHE suave para bajo contraste
    try:
        gray = apply_clahe(gray)
    except Exception:
        pass

    return gray


‚∏ª

üîí Reglas obligatorias de normalizaci√≥n
	‚Ä¢	‚úîÔ∏è Orden exacto de pasos
	‚Ä¢	‚úîÔ∏è Cada paso aislado con try/except
	‚Ä¢	‚úîÔ∏è Nunca devolver None
	‚Ä¢	‚úîÔ∏è No cambiar resoluci√≥n despu√©s del OCR
	‚Ä¢	‚ùå No hacer OCR ac√°
	‚Ä¢	‚ùå No loguear imagen

‚∏ª

üìå Helpers que deben existir (sin l√≥gica extra)

deskew(image)
trim_background(image)
find_largest_rectangular_contour(image)
crop_to_box(image, box)
resize_to_width(image, width)
apply_clahe(image)

Cada helper:
	‚Ä¢	hace una sola cosa
	‚Ä¢	si falla ‚Üí excepci√≥n (capturada arriba)

‚∏ª

‚úÖ ESTADO FINAL ESPERADO

Despu√©s de implementar solo esto:
	‚Ä¢	El OCR recibe im√°genes limpias
	‚Ä¢	PDF417 parcial no rompe
	‚Ä¢	Documento lejano se corrige
	‚Ä¢	Cada strategy hace solo lo suyo
	‚Ä¢	El pipeline queda determin√≠stico y robusto

‚∏ª

Cuando quieras seguimos con:
	‚Ä¢	helpers (deskew, trim_background) l√≠nea por l√≠nea
	‚Ä¢	o tuning fino de thresholds reales por cliente